<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>3DVR - Notes</title>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<style>
body {
  font-family: 'Poppins', sans-serif;
  background: #e9f0f5;
  color: #222;
  margin: 0;
  padding: 20px;
}
h1 {
  text-align: center;
  margin-bottom: 20px;
}
.top-buttons {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-bottom: 20px;
}
.top-buttons a {
  background: #66c2b0;
  color: white;
  padding: 10px 20px;
  border-radius: 8px;
  text-decoration: none;
  font-weight: bold;
}
.top-buttons a:hover {
  background: #5ca0d3;
}
.section {
  background: white;
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 20px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}
input, button {
  padding: 10px;
  font-size: 1rem;
  border-radius: 8px;
  border: 1px solid #ccc;
}
button {
  background: #66c2b0;
  color: white;
  font-weight: bold;
  cursor: pointer;
}
button:hover {
  background: #5ca0d3;
}
.folder, .note {
  background: #f9fbfc;
  padding: 10px;
  margin: 10px 0;
  border-radius: 8px;
}
.folder-title, .note-text {
  font-weight: bold;
  cursor: pointer;
}
.nested {
  margin-left: 20px;
}
.add-subnote {
  margin-top: 5px;
}
.delete-btn {
  background: #e74c3c;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 4px 8px;
  cursor: pointer;
  font-size: 0.8rem;
  margin-left: 10px;
}
.breadcrumbs {
  margin-bottom: 20px;
}
.breadcrumbs span {
  cursor: pointer;
  color: #3498db;
}
.breadcrumbs span:hover {
  text-decoration: underline;
}
.hidden {
  display: none;
}
</style>
</head>
<body>

<div class="top-buttons">
  <a href="index.html">ğŸ  Back to Portal</a>
  <a href="https://3dvr.tech/#subscribe" target="_blank">â­ Subscribe</a>
  <a href="https://github.com/tmsteph/3dvr-portal" target="_blank">ğŸš€ Contribute on GitHub</a>
</div>

<h1>ğŸ“ 3DVR Notes</h1>
<div class="breadcrumbs hidden" id="breadcrumbs"></div>

<div id="main-view">

  <div class="section">
    <h2>Create Folder</h2>
    <input type="text" id="folder-name" placeholder="Folder Name">
    <label><input type="checkbox" id="folder-shared"> Shared Folder</label>
    <button onclick="FolderComponent.create()">Add Folder</button>
  </div>

  <div class="section">
    <h2>ğŸ“ My Folders</h2>
    <div id="my-folders"></div>
  </div>

  <div class="section">
    <h2>ğŸŒ Shared Folders</h2>
    <div id="shared-folders"></div>
  </div>

</div>

<div id="zoom-view" class="hidden"></div>

<script>
const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
const userId = localStorage.getItem('userId') || (() => {
  const id = 'user_' + Math.random().toString(36).substr(2, 9);
  localStorage.setItem('userId', id);
  return id;
})();
const user = gun.get('3dvr-users').get(userId);
const folders = gun.get('3dvr-folders');
const notes = gun.get('3dvr-notes');

let currentView = { type: 'main', id: null };

const Points = {
  reward(amount) {
    user.get('score').once(score => {
      user.get('score').put((score || 0) + amount);
    });
  }
};

function setView(type, id, path = []) {
  currentView = { type, id };
  document.getElementById('main-view').classList.toggle('hidden', type !== 'main');
  document.getElementById('zoom-view').classList.toggle('hidden', type === 'main');
  const breadcrumbs = document.getElementById('breadcrumbs');
  breadcrumbs.classList.toggle('hidden', type === 'main');
  breadcrumbs.innerHTML = '';
  path.forEach((item, index) => {
    const span = document.createElement('span');
    span.textContent = item.label;
    span.onclick = () => setView(item.type, item.id, path.slice(0, index + 1));
    breadcrumbs.appendChild(span);
    if (index < path.length - 1) breadcrumbs.appendChild(document.createTextNode(" > "));
  });
}

const NoteComponent = {
  render(note, id, container, path, isChild = false) {
    const noteDiv = document.createElement('div');
    noteDiv.className = 'note' + (isChild ? ' nested' : '');
    noteDiv.id = id;

    const toggle = document.createElement('span');
    toggle.textContent = "â–¶";
    toggle.style.cursor = "pointer";
    toggle.style.marginRight = "8px";

    const noteText = document.createElement('span');
    noteText.className = 'note-text';
    noteText.textContent = note.text;
    noteText.onclick = () => setView("note", id, [...path, { type: "note", id, label: note.text }]);

    let expanded = true;
    toggle.onclick = () => {
      expanded = !expanded;
      childDiv.classList.toggle('hidden', !expanded);
      toggle.textContent = expanded ? "â–¼" : "â–¶";
    };

    const delButton = document.createElement('button');
    delButton.className = 'delete-btn';
    delButton.textContent = "Delete";
    delButton.onclick = () => notes.get(id).put(null);

    const childDiv = document.createElement('div');

    noteDiv.appendChild(toggle);
    noteDiv.appendChild(noteText);
    noteDiv.appendChild(delButton);
    noteDiv.appendChild(childDiv);
    container.appendChild(noteDiv);

    return childDiv;
  }
};

const FolderComponent = {
  create() {
    const name = document.getElementById('folder-name').value.trim();
    const shared = document.getElementById('folder-shared').checked;
    if (!name) return;

    const folder = { name, shared, createdBy: userId, createdAt: Date.now() };
    folders.set(folder);
    Points.reward(20);
    document.getElementById('folder-name').value = '';
    document.getElementById('folder-shared').checked = false;
  },

  render(folder, id, container) {
    const folderDiv = document.createElement('div');
    folderDiv.className = 'folder';
    folderDiv.id = "folder_" + id;

    const title = document.createElement('span');
    title.className = 'folder-title';
    title.textContent = folder.name + (folder.shared ? ' (Shared)' : '');
    title.onclick = () => setView("folder", id, [{ type: "folder", id, label: folder.name }]);

    folderDiv.appendChild(title);
    container.appendChild(folderDiv);
  }
};

folders.map().on((folder, id) => {
  if (!folder || document.getElementById('folder_' + id)) return;
  const container = folder.shared ? document.getElementById('shared-folders') : document.getElementById('my-folders');
  FolderComponent.render(folder, id, container);
});

notes.map().on((note, id) => {
  if (!note || !note.folderId) return;

  if (currentView.type === "folder" && currentView.id === note.folderId) {
    const zoom = document.getElementById('zoom-view');
    zoom.innerHTML = `<h2>ğŸ“ ${note.folderId}</h2>`;
    const container = document.createElement('div');
    zoom.appendChild(container);
    renderNoteAndChildren(note, id, container, [{ type: "folder", id: note.folderId, label: note.folderId }]);
  }
});

function renderNoteAndChildren(note, id, container, path) {
  const childDiv = NoteComponent.render(note, id, container, path);
  notes.map().on((subnote, subid) => {
    if (!subnote || subnote.parentId !== id) return;
    renderNoteAndChildren(subnote, subid, childDiv, [...path, { type: "note", id, label: note.text }]);
  });
}
</script>

</body>
</html>
