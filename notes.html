<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>3DVR - Notes</title>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<style>
body {
  font-family: 'Poppins', sans-serif;
  background: #eef2f5;
  color: #333;
  margin: 0;
  padding: 20px;
}
h1 {
  text-align: center;
}
.top-buttons {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-bottom: 20px;
}
.top-buttons a {
  background: #66c2b0;
  color: white;
  padding: 10px 20px;
  border-radius: 8px;
  text-decoration: none;
  font-weight: bold;
}
.top-buttons a:hover {
  background: #5ca0d3;
}
.breadcrumbs {
  margin-bottom: 20px;
  font-size: 0.9rem;
}
.breadcrumbs span {
  cursor: pointer;
  color: #3498db;
}
.breadcrumbs span:hover {
  text-decoration: underline;
}
.section {
  background: white;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}
input, button {
  padding: 8px;
  font-size: 1rem;
  border-radius: 6px;
  border: 1px solid #ccc;
}
button {
  background: #66c2b0;
  color: white;
  font-weight: bold;
  cursor: pointer;
}
button:hover {
  background: #5ca0d3;
}
.folder, .note {
  background: #f9fbfc;
  padding: 10px;
  margin: 10px 0;
  border-radius: 6px;
  position: relative;
}
.folder-title, .note-text {
  font-weight: bold;
  cursor: pointer;
}
.nested {
  margin-left: 20px;
  padding-left: 10px;
  border-left: 2px solid #ccc;
}
.hidden {
  display: none;
}
.delete-btn {
  background: #e74c3c;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 4px 8px;
  cursor: pointer;
  font-size: 0.8rem;
  margin-left: 10px;
}
.add-box {
  margin-top: 10px;
}
</style>
</head>
<body>

<div class="top-buttons">
  <a href="index.html">ğŸ  Back to Portal</a>
  <a href="https://3dvr.tech/#subscribe" target="_blank">â­ Subscribe</a>
  <a href="https://github.com/tmsteph/3dvr-portal" target="_blank">ğŸš€ Contribute on GitHub</a>
</div>

<h1>ğŸ“ 3DVR Notes</h1>
<div class="breadcrumbs hidden" id="breadcrumbs"></div>

<div id="main-view">
  <div class="section">
    <h2>Create Folder</h2>
    <input type="text" id="folder-name" placeholder="Folder Name">
    <label><input type="checkbox" id="folder-shared"> Shared Folder</label>
    <button onclick="FolderComponent.create()">Add Folder</button>
  </div>

  <div class="section">
    <h2>ğŸ“ My Folders</h2>
    <div id="my-folders"></div>
  </div>

  <div class="section">
    <h2>ğŸŒ Shared Folders</h2>
    <div id="shared-folders"></div>
  </div>
</div>

<div id="zoom-view" class="hidden"></div>

<script>
const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
const userId = localStorage.getItem('userId') || (() => {
  const id = 'user_' + Math.random().toString(36).substr(2, 9);
  localStorage.setItem('userId', id);
  return id;
})();
const user = gun.get('3dvr-users').get(userId);
const folders = gun.get('3dvr-folders');
const notes = gun.get('3dvr-notes');

let view = { type: 'main', id: null };

const Points = {
  reward(amount) {
    user.get('score').once(score => {
      user.get('score').put((score || 0) + amount);
    });
  }
};

function setView(type, id, path=[]) {
  view = { type, id };
  document.getElementById('main-view').classList.toggle('hidden', type !== 'main');
  document.getElementById('zoom-view').classList.toggle('hidden', type === 'main');
  const bc = document.getElementById('breadcrumbs');
  bc.classList.toggle('hidden', type === 'main');
  bc.innerHTML = '';
  const home = document.createElement('span');
  home.textContent = "All Folders";
  home.onclick = () => setView('main');
  bc.appendChild(home);
  path.forEach((p, i) => {
    bc.appendChild(document.createTextNode(" > "));
    const sp = document.createElement('span');
    sp.textContent = p.label;
    sp.onclick = () => setView(p.type, p.id, path.slice(0, i + 1));
    bc.appendChild(sp);
  });
}

function renderAddBox(parentId, folderId, container) {
  const box = document.createElement('div');
  box.className = "add-box";
  const input = document.createElement('input');
  input.placeholder = "Add note...";
  const btn = document.createElement('button');
  btn.textContent = "Add";
  btn.onclick = () => {
    const text = input.value.trim();
    if (!text) return;
    const note = { text, folderId, parentId: parentId || null, createdBy: userId, createdAt: Date.now() };
    notes.set(note);
    Points.reward(10);
    input.value = '';
  };
  box.appendChild(input);
  box.appendChild(btn);
  container.appendChild(box);
}

const NoteComponent = {
  render(note, id, container, path, isChild=false) {
    const noteDiv = document.createElement('div');
    noteDiv.className = 'note' + (isChild ? ' nested' : '');
    noteDiv.id = id;

    const toggle = document.createElement('span');
    toggle.textContent = "â–¼";
    toggle.style.cursor = "pointer";
    toggle.style.marginRight = "8px";

    const noteText = document.createElement('span');
    noteText.className = 'note-text';
    noteText.textContent = note.text;
    noteText.onclick = () => setView("note", id, [...path, { type:"note", id, label:note.text }]);

    const delBtn = document.createElement('button');
    delBtn.className = 'delete-btn';
    delBtn.textContent = "Delete";
    delBtn.onclick = () => notes.get(id).put(null);

    const children = document.createElement('div');
    children.className = 'children';

    toggle.onclick = () => children.classList.toggle('hidden');

    noteDiv.appendChild(toggle);
    noteDiv.appendChild(noteText);
    noteDiv.appendChild(delBtn);
    noteDiv.appendChild(children);
    container.appendChild(noteDiv);

    renderAddBox(id, note.folderId, children);

    notes.map().on((subnote, subid) => {
      if (subnote && subnote.parentId === id) {
        NoteComponent.render(subnote, subid, children, [...path, {type:"note", id, label:note.text}], true);
      }
    });
  }
};

const FolderComponent = {
  create() {
    const name = document.getElementById('folder-name').value.trim();
    const shared = document.getElementById('folder-shared').checked;
    if (!name) return;
    folders.set({ name, shared, createdBy: userId, createdAt: Date.now() });
    Points.reward(20);
    document.getElementById('folder-name').value = '';
    document.getElementById('folder-shared').checked = false;
  },

  render(folder, id, container) {
    const div = document.createElement('div');
    div.className = 'folder';
    div.id = "folder_" + id;

    const title = document.createElement('span');
    title.className = 'folder-title';
    title.textContent = folder.name + (folder.shared ? ' (Shared)' : '');
    title.onclick = () => setView('folder', id, [{type:"folder", id, label:folder.name}]);

    const delBtn = document.createElement('button');
    delBtn.className = 'delete-btn';
    delBtn.textContent = "Delete";
    delBtn.onclick = () => folders.get(id).put(null);

    div.appendChild(title);
    div.appendChild(delBtn);
    container.appendChild(div);
  }
};

folders.map().on((folder, id) => {
  if (!folder || document.getElementById('folder_' + id)) return;
  const cont = folder.shared ? document.getElementById('shared-folders') : document.getElementById('my-folders');
  FolderComponent.render(folder, id, cont);
});

notes.map().on((note, id) => {
  if (!note || !note.folderId) return;

  if (view.type === "folder" && view.id === note.folderId) {
    const zoom = document.getElementById('zoom-view');
    zoom.innerHTML = `<h2>ğŸ“ ${note.folderId}</h2>`;
    const cont = document.createElement('div');
    zoom.appendChild(cont);
    renderAddBox(null, note.folderId, cont);
    renderNoteAndChildren(note, id, cont, [{type:"folder", id:note.folderId, label:note.folderId}]);
  }

  if (view.type === "note" && view.id === id) {
    const zoom = document.getElementById('zoom-view');
    zoom.innerHTML = `<h2>ğŸ“ ${note.text}</h2>`;
    const cont = document.createElement('div');
    zoom.appendChild(cont);
    renderAddBox(id, note.folderId, cont);
    notes.map().on((sub, subid) => {
      if (sub && sub.parentId === id) NoteComponent.render(sub, subid, cont, []);
    });
  }
});

function renderNoteAndChildren(note, id, container, path) {
  const children = NoteComponent.render(note, id, container, path);
}
</script>

</body>
</html>
