<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>3DVR - Advanced Task Board</title>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Placeholder: Insert your CSS here, same as original */
  </style>
</head>
<body>
  <!-- Placeholder: Insert your top-buttons, user-info, filters, new task form, and kanban columns -->

  <script>
    const gun = Gun({
      peers: [
        'https://gun-manhattan.herokuapp.com/gun',
        'https://gun-eu.herokuapp.com/gun',
        'https://gun-us.herokuapp.com/gun',
        'https://gun-manhattan2.herokuapp.com/gun'
      ]
    });

    const tasks = gun.get('3dvr-tasks');
    const taskList = {};

    tasks.map().on((task, id) => {
      if (!task) {
        delete taskList[id];
      } else {
        taskList[id] = task;
      }
      renderTasks();
    });

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function getPriorityIcon(priority) {
      switch (priority) {
        case 'high': return 'ğŸ”¥';
        case 'medium': return 'âš¡';
        case 'low': return 'ğŸ“Œ';
        default: return 'ğŸ“Œ';
      }
    }

    function getDueDateStatus(dueDate) {
      if (!dueDate) return { class: '', text: '' };
      const today = new Date();
      const due = new Date(dueDate);
      const diffTime = due - today;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

      if (diffDays < 0) return { class: 'overdue', text: `(${Math.abs(diffDays)} days overdue)` };
      if (diffDays <= 1) return { class: 'due-soon', text: diffDays === 0 ? '(Due today)' : '(Due tomorrow)' };
      if (diffDays <= 3) return { class: 'due-soon', text: `(Due in ${diffDays} days)` };
      return { class: '', text: '' };
    }

    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString();
    }

    function formatDateTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleString();
    }

    function createTaskElement(id, task) {
      const div = document.createElement('div');
      div.className = `task ${task.completed ? 'completed' : ''}`;
      div.id = id;
      div.draggable = true;

      div.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', id);
        div.classList.add('dragging');
      });

      div.addEventListener('dragend', () => {
        div.classList.remove('dragging');
      });

      const title = task.title || task.text || '(Untitled Task)';
      const description = task.description || (task.text !== title ? task.text : '');
      const dueDateStatus = getDueDateStatus(task.dueDate);

      div.innerHTML = `
        <div class="task-header">
          <div class="task-title">${escapeHtml(title)}</div>
          <div class="task-actions">
            <button class="task-action" onclick="editTask('${id}')" title="Edit">âœï¸</button>
            <button class="task-action" onclick="showHistory('${id}')" title="History">ğŸ“œ</button>
            <button class="task-action" onclick="deleteTask('${id}')" title="Delete">ğŸ—‘ï¸</button>
          </div>
        </div>
        ${description ? `<div class="task-description">${escapeHtml(description)}</div>` : ''}
        <div class="task-meta">
          <span class="task-priority priority-${task.priority || 'medium'}">
            ${getPriorityIcon(task.priority || 'medium')} ${(task.priority || 'medium').toUpperCase()}
          </span>
          ${task.dueDate ? `<span class="task-due-date ${dueDateStatus.class}">ğŸ“… ${formatDate(task.dueDate)} ${dueDateStatus.text}</span>` : ''}
          ${task.assignee ? `<span class="task-assignee">ğŸ‘¤ ${escapeHtml(task.assignee)}</span>` : ''}
        </div>
      `;

      return div;
    }

    function renderTasks() {
      const container = document.getElementById('tasks') || document.createElement('div');
      container.innerHTML = '';
      Object.entries(taskList).forEach(([id, task]) => {
        const taskEl = createTaskElement(id, task);
        container.appendChild(taskEl);
      });
    }
  </script>
</body>
</html>
